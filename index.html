<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompanyIntel.ro - Informa»õii Financiare Complete</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè¢</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Top Bar */
        .top-bar {
            background: #0F7CC0;
            color: white;
            padding: 10px 0;
            font-size: 13px;
        }

        .top-bar .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 3px solid #f78153;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .logo h1 {
            color: #0F7CC0;
            font-size: 28px;
        }

        .logo .highlight {
            color: #f78153;
        }

        /* Search Section */
        .search-section {
            background: linear-gradient(135deg, #0F7CC0 0%, #0a5a8f 100%);
            padding: 30px 20px;
            color: white;
        }

        .search-section .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-form {
            display: flex;
            gap: 10px;
            max-width: 600px;
        }

        /* Browse Section */
        .browse-section {
            background: #f9f9f9;
            padding: 30px 20px;
            border-top: 3px solid #f78153;
        }

        .browse-section .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .browse-section h2 {
            color: #0F7CC0;
            margin-bottom: 20px;
        }

        .filters-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .filter-item label {
            display: block;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .filter-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-item input[type="checkbox"] {
            margin-right: 8px;
        }

        /* Company List Table */
        .company-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .company-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .company-table th {
            background: #0F7CC0;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
        }

        .company-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .company-table tbody tr:hover {
            background: #f5f5f5;
            cursor: pointer;
        }

        .company-table .cif-link {
            color: #0F7CC0;
            font-weight: 600;
            text-decoration: none;
        }

        .company-table .cif-link:hover {
            text-decoration: underline;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            background: white;
            color: #0F7CC0;
            border: 1px solid #0F7CC0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination button:hover {
            background: #0F7CC0;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #0F7CC0;
            color: white;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
        }

        button {
            padding: 12px 30px;
            background: #f78153;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover {
            background: #e56a3d;
        }

        /* Results Container */
        .results-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
            display: none;
        }

        .results-container.show {
            display: block;
        }

        /* Company Header Card */
        .company-header {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .company-name {
            font-size: 26px;
            font-weight: bold;
            color: #0F7CC0;
            margin-bottom: 15px;
        }

        .company-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .meta-item {
            display: flex;
            gap: 10px;
        }

        .meta-label {
            font-weight: 600;
            color: #666;
            min-width: 80px;
        }

        .meta-value {
            color: #333;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #0F7CC0;
        }

        .summary-card .label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #0F7CC0;
        }

        .summary-card .change {
            font-size: 13px;
            margin-top: 5px;
        }

        .summary-card .change.positive {
            color: #10b981;
        }

        .summary-card .change.negative {
            color: #ef4444;
        }

        /* Charts Section */
        .charts-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #0F7CC0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f78153;
        }

        /* Compact Table */
        .data-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .compact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .compact-table th {
            background: #0F7CC0;
            color: white;
            padding: 12px 10px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            border-bottom: 3px solid #f78153;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .compact-table th:first-child {
            text-align: left;
            background: #0a5a8f;
        }

        .compact-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #f0f0f0;
        }

        .compact-table th {
            border-right: 1px solid rgba(255,255,255,0.3);
        }

        .compact-table td:first-child {
            font-weight: 600;
            color: #333;
            background: #fafafa;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .compact-table tbody tr:hover {
            background: #f9f9f9;
        }

        .value-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .change-indicator {
            font-size: 11px;
            margin-left: 8px;
        }

        .change-indicator.positive {
            color: #10b981;
        }

        .change-indicator.negative {
            color: #ef4444;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f78153;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 20px;
            border-radius: 4px;
            border-left: 4px solid #dc2626;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="container">
            üìä 8,390 companii ‚Ä¢ 5,306 cu date complete ‚Ä¢ 12 ani (2013-2024)
        </div>
    </div>

    <div class="header">
        <div class="container">
            <div class="logo">
                <h1>Company<span class="highlight">Intel</span>.ro</h1>
            </div>
        </div>
    </div>

    <div class="search-section">
        <div class="container">
            <h2>CƒÉutare Companie dupƒÉ CIF</h2>
            <form class="search-form" onsubmit="searchCompany(event)">
                <input type="text" id="cifInput" placeholder="Introduce»õi CIF (ex: 29036053)" required>
                <button type="submit">CƒÉutare</button>
            </form>
        </div>
    </div>

    <!-- Browse Section with Filters -->
    <div class="browse-section">
        <div class="container">
            <h2>RƒÉsfoie»ôte Companii</h2>
            <div class="filters-container">
                <div class="filter-row">
                    <div class="filter-item">
                        <label>Jude»õ:</label>
                        <select id="filterJudet" onchange="applyFilters()">
                            <option value="">Toate</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Ora»ô:</label>
                        <select id="filterOras" onchange="applyFilters()">
                            <option value="">Toate</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>COD CAEN:</label>
                        <select id="filterCaen" onchange="applyFilters()">
                            <option value="">Toate</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-item">
                        <label><input type="checkbox" id="filterHasName" onchange="applyFilters()"> Cu Nume</label>
                    </div>
                    <div class="filter-item">
                        <label><input type="checkbox" id="filterHasAddress" onchange="applyFilters()"> Cu AdresƒÉ</label>
                    </div>
                    <div class="filter-item">
                        <label><input type="checkbox" id="filterHasPhone" onchange="applyFilters()"> Cu Telefon</label>
                    </div>
                </div>
            </div>
            <div id="browseResults"></div>
            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <div class="results-container" id="results">
        <div id="resultsContent"></div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : '/api';

        async function searchCompany(event) {
            event.preventDefault();
            console.log('[SEARCH] Starting...');

            const cif = document.getElementById('cifInput').value.trim();
            const resultsContainer = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');

            resultsContainer.classList.add('show');
            resultsContent.innerHTML = '<div class="loading"><div class="loader"></div><p>Se √ÆncarcƒÉ...</p></div>';

            try {
                const response = await fetch(`${API_URL}/search?cif=${encodeURIComponent(cif)}`);
                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    resultsContent.innerHTML = `<div class="error">${data.error}</div>`;
                }
            } catch (error) {
                resultsContent.innerHTML = `<div class="error">Eroare: ${error.message}</div>`;
            }
        }

        function displayResults(data) {
            if (!data.years || data.years.length === 0) {
                document.getElementById('resultsContent').innerHTML = '<div class="error">Nu existƒÉ date disponibile</div>';
                return;
            }

            data.years.sort((a, b) => b.an - a.an);

            let html = '';

            // Company Header
            html += '<div class="company-header">';
            html += `<div class="company-name">${data.company_name || 'CIF ' + data.cif}</div>`;
            html += '<div class="company-meta">';
            html += `<div class="meta-item"><span class="meta-label">CIF:</span><span class="meta-value">${data.cif}</span></div>`;
            if (data.j_number) html += `<div class="meta-item"><span class="meta-label">J:</span><span class="meta-value">${data.j_number}</span></div>`;
            if (data.full_address) html += `<div class="meta-item"><span class="meta-label">AdresƒÉ:</span><span class="meta-value">${data.full_address}</span></div>`;
            if (data.phone) html += `<div class="meta-item"><span class="meta-label">Telefon:</span><span class="meta-value">${data.phone}</span></div>`;
            if (data.cod_caen) html += `<div class="meta-item"><span class="meta-label">COD CAEN:</span><span class="meta-value">${data.cod_caen}</span></div>`;
            html += '</div></div>';

            // Summary Cards (Last year data)
            const lastYear = data.years[0];
            const prevYear = data.years[1] || {};

            html += '<div class="summary-cards">';
            html += createSummaryCard('Cifra de Afaceri', lastYear.cifra_de_afaceri_neta, prevYear.cifra_de_afaceri_neta);
            html += createSummaryCard('Profit Net', lastYear.profit_net, prevYear.profit_net);
            html += createSummaryCard('Angaja»õi', lastYear.salariati, prevYear.salariati, false);
            html += createSummaryCard('Datorii', lastYear.datorii, prevYear.datorii);
            html += '</div>';

            // Charts
            html += '<div class="charts-section">';
            html += '<div class="section-title">üìà Evolu»õie FinanciarƒÉ</div>';
            html += '<canvas id="revenueChart" height="80"></canvas>';
            html += '</div>';

            // Compact Table - Last 5 Years
            html += '<div class="data-section">';
            html += '<div class="section-title">üìä Date Financiare (Ultimii 5 Ani)</div>';
            html += createCompactTable(data.years.slice(0, 5));
            html += '</div>';

            document.getElementById('resultsContent').innerHTML = html;

            // Render chart
            renderChart(data.years);
        }

        function createSummaryCard(label, current, previous, isCurrency = true) {
            const change = previous && current ? ((current - previous) / previous * 100) : 0;
            const changeClass = change > 0 ? 'positive' : (change < 0 ? 'negative' : '');
            const changeSymbol = change > 0 ? '‚Üë' : (change < 0 ? '‚Üì' : '');

            return `
                <div class="summary-card">
                    <div class="label">${label}</div>
                    <div class="value">${formatNumber(current, isCurrency)}</div>
                    ${previous ? `<div class="change ${changeClass}">${changeSymbol} ${Math.abs(change).toFixed(1)}%</div>` : ''}
                </div>
            `;
        }

        function createCompactTable(years) {
            let html = '<table class="compact-table"><thead><tr><th>Indicator</th>';
            years.forEach(y => html += `<th>${y.an}</th>`);
            html += '</tr></thead><tbody>';

            const indicators = [
                {label: 'Cifra de Afaceri NetƒÉ', key: 'cifra_de_afaceri_neta'},
                {label: 'Venituri Totale', key: 'venituri_totale'},
                {label: 'Cheltuieli Totale', key: 'cheltuieli_totale'},
                {label: 'Profit Brut', key: 'profit_brut', positive: true},
                {label: 'Pierdere Brut', key: 'pierdere_brut', negative: true},
                {label: 'Profit Net', key: 'profit_net', positive: true},
                {label: 'Pierdere Net', key: 'pierdere_net', negative: true},
                {label: 'Active Imobilizate', key: 'active_imobilizate'},
                {label: 'Active Circulante', key: 'active_circulante'},
                {label: 'Stocuri', key: 'stocuri'},
                {label: 'Crean»õe', key: 'creante'},
                {label: 'Datorii', key: 'datorii'},
                {label: 'Provizioane', key: 'provizioane'},
                {label: 'Capitaluri Total', key: 'capitaluri_total'},
                {label: 'Patrimoniul Regiei', key: 'patrimoniul_regiei'},
                {label: 'Salaria»õi', key: 'salariati', isCurrency: false},
            ];

            indicators.forEach(ind => {
                html += `<tr><td>${ind.label}</td>`;
                for (let i = 0; i < years.length; i++) {
                    const current = years[i][ind.key];
                    const previous = i < years.length - 1 ? years[i + 1][ind.key] : null;
                    const change = previous && current ? ((current - previous) / previous * 100) : 0;
                    const changeClass = change > 0 ? 'positive' : (change < 0 ? 'negative' : '');
                    const changeSymbol = change > 0 ? '‚Üë' : (change < 0 ? '‚Üì' : '');

                    let cellClass = '';
                    if (ind.positive) cellClass = 'positive';
                    if (ind.negative) cellClass = 'negative';

                    html += `<td class="value-cell ${cellClass}">`;
                    html += formatNumber(current, ind.isCurrency !== false);
                    if (previous && change !== 0) {
                        html += `<span class="change-indicator ${changeClass}"> ${changeSymbol}${Math.abs(change).toFixed(0)}%</span>`;
                    }
                    html += '</td>';
                }
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function renderChart(years) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;

            const sortedYears = [...years].sort((a, b) => a.an - b.an);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedYears.map(y => y.an),
                    datasets: [
                        {
                            label: 'Cifra de Afaceri',
                            data: sortedYears.map(y => y.cifra_de_afaceri_neta),
                            borderColor: '#0F7CC0',
                            backgroundColor: 'rgba(15, 124, 192, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Profit Net',
                            data: sortedYears.map(y => y.profit_net),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatNumber(context.parsed.y, true);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function formatNumber(value, isCurrency = true) {
            if (value === null || value === undefined || value === 0) return '-';
            const num = parseInt(value).toLocaleString('ro-RO');
            return isCurrency ? num + ' RON' : num;
        }

        // Filter and Browse Functions
        let currentPage = 1;
        let filtersLoaded = false;

        async function loadFilters() {
            if (filtersLoaded) return;

            try {
                const response = await fetch(`${API_URL}/filters`);
                const data = await response.json();

                // Populate Jude»õ
                const judetSelect = document.getElementById('filterJudet');
                data.judete.forEach(judet => {
                    const option = document.createElement('option');
                    option.value = judet;
                    option.textContent = judet;
                    judetSelect.appendChild(option);
                });

                // Populate Ora»ô
                const orasSelect = document.getElementById('filterOras');
                data.orase.forEach(oras => {
                    const option = document.createElement('option');
                    option.value = oras;
                    option.textContent = oras;
                    orasSelect.appendChild(option);
                });

                // Populate COD CAEN
                const caenSelect = document.getElementById('filterCaen');
                data.cod_caen.forEach(caen => {
                    const option = document.createElement('option');
                    option.value = caen;
                    option.textContent = caen;
                    caenSelect.appendChild(option);
                });

                filtersLoaded = true;

                // Load initial company list
                applyFilters();
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }

        async function applyFilters(page = 1) {
            currentPage = page;

            const params = new URLSearchParams();
            params.append('page', page);
            params.append('per_page', 50);

            const judet = document.getElementById('filterJudet').value;
            if (judet) params.append('judet', judet);

            const oras = document.getElementById('filterOras').value;
            if (oras) params.append('oras', oras);

            const caen = document.getElementById('filterCaen').value;
            if (caen) params.append('cod_caen', caen);

            if (document.getElementById('filterHasName').checked) {
                params.append('has_name', 'true');
            }

            if (document.getElementById('filterHasAddress').checked) {
                params.append('has_address', 'true');
            }

            if (document.getElementById('filterHasPhone').checked) {
                params.append('has_phone', 'true');
            }

            try {
                document.getElementById('browseResults').innerHTML = '<div class="loading"><div class="loader"></div><p>Se √ÆncarcƒÉ...</p></div>';

                const response = await fetch(`${API_URL}/companies?${params}`);
                const data = await response.json();

                displayCompanyList(data);
            } catch (error) {
                document.getElementById('browseResults').innerHTML = `<div class="error">Eroare: ${error.message}</div>`;
            }
        }

        function displayCompanyList(data) {
            let html = '<div class="company-table">';
            html += '<table><thead><tr>';
            html += '<th>CIF</th>';
            html += '<th>Nume</th>';
            html += '<th>Jude»õ</th>';
            html += '<th>Ora»ô</th>';
            html += '<th>AdresƒÉ</th>';
            html += '<th>Telefon</th>';
            html += '<th>COD CAEN</th>';
            html += '<th>Cifra Afaceri 2024</th>';
            html += '<th>Cifra Afaceri 2023</th>';
            html += '</tr></thead><tbody>';

            data.companies.forEach(company => {
                html += '<tr onclick="clickCompany(\'' + company.cif + '\')">';
                html += `<td><a href="#" class="cif-link" onclick="event.preventDefault(); clickCompany('${company.cif}')">${company.cif}</a></td>`;
                html += `<td>${company.company_name || '-'}</td>`;
                html += `<td>${company.judet || '-'}</td>`;
                html += `<td>${company.oras || '-'}</td>`;
                html += `<td>${company.full_address ? (company.full_address.length > 50 ? company.full_address.substring(0, 50) + '...' : company.full_address) : '-'}</td>`;
                html += `<td>${company.phone || '-'}</td>`;
                html += `<td>${company.cod_caen || '-'}</td>`;
                html += `<td>${formatNumber(company.cifra_de_afaceri_2024)}</td>`;
                html += `<td>${formatNumber(company.cifra_de_afaceri_2023)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            // Pagination info
            html += `<p style="text-align: center; margin-top: 15px; color: #666;">Afi»ôare ${data.companies.length} din ${data.total.toLocaleString('ro-RO')} companii</p>`;

            document.getElementById('browseResults').innerHTML = html;

            // Render pagination
            renderPagination(data);
        }

        function renderPagination(data) {
            const totalPages = Math.ceil(data.total / data.per_page);
            let html = '';

            // Previous button
            html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="applyFilters(${currentPage - 1})">‚Äπ Anterior</button>`;

            // Page numbers (show max 5 pages)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="applyFilters(${i})">${i}</button>`;
            }

            // Next button
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="applyFilters(${currentPage + 1})">UrmƒÉtor ‚Ä∫</button>`;

            document.getElementById('pagination').innerHTML = html;
        }

        function clickCompany(cif) {
            // Set CIF in search box
            document.getElementById('cifInput').value = cif;

            // Trigger search
            searchCompany({preventDefault: () => {}});

            // Scroll to results
            document.getElementById('results').scrollIntoView({behavior: 'smooth'});
        }

        // Load filters on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadFilters();
        });
    </script>
</body>
</html>
